<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My New Tab</title>
  <style>
    :root{
      --bg-blur: 6px;
      --controls-visible: none;
      --tile-size: 92px;
      --tile-radius: 16px;
      --gap: 14px;
      --glass: rgba(255,255,255,0.05);
      --glass-strong: rgba(255,255,255,0.12);
      --text: #f2f4f8;
      --muted: #cbd5e1;
      --shadow: 0 6px 24px rgba(0,0,0,0.25);
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: #0b1220;
      overflow: hidden;
    }
    .bg {
      position: fixed; inset: 0; background-size: cover; background-position: center; 
      /* filter: blur(var(--bg-blur)); transform: scale(1.04); opacity: 0.95; */
    }
    .scrim{ position: fixed; inset:0; background: radial-gradient(1200px 800px at 50% 20%, rgba(0,0,0,0.15), rgba(0,0,0,0.55) 60%, rgba(0,0,0,0.75)); }

    .container{ position: relative; height: 100%; display: grid; grid-template-rows: auto 1fr auto; }

    header{ display:flex; align-items:center; justify-content:space-between; padding: 24px 28px; }
    .clock-container{ display:flex; flex-direction:column; gap:2px; }
    .date{ font-weight: 500; font-size: 14px; letter-spacing: 0.3px; opacity: 0.85; text-shadow: 0 1px 6px rgba(0,0,0,0.3); }
    .clock{ font-weight: 700; font-size: 28px; letter-spacing: 0.6px; text-shadow: 0 2px 10px rgba(0,0,0,0.35); }
    .controls{ display:none; gap:10px; align-items:center; }
    .controls.visible{ display:flex; }
    button, input, select{ height: 36px; border-radius: 10px; border: 1px solid var(--glass-strong); background: var(--glass); color: var(--text); padding: 0 12px; backdrop-filter: blur(6px); box-shadow: var(--shadow); }
    button { cursor: pointer; }
    button:hover{ background: var(--glass-strong); }
    select{ cursor: pointer; }
    select:hover{ background: var(--glass-strong); }

    main{ padding: 10px 28px 28px; overflow: auto; }
    .grid{ display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--tile-size), 1fr)); gap: var(--gap); }
    .tile{ user-select: none; background: var(--glass); border:1px solid var(--glass-strong); height: var(--tile-size); border-radius: var(--tile-radius); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; text-decoration:none; color:var(--text); box-shadow: var(--shadow); position: relative; transition: transform 120ms ease, background 120ms ease, border-color 120ms ease; }
    .tile:hover{ transform: translateY(-2px); background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.22); }
    .tile:active{ transform: translateY(0); }
    .tile .favicon{ width: 28px; height: 28px; border-radius: 6px; background: rgba(255,255,255,0.12); display:grid; place-items:center; overflow:hidden; }
    .tile .favicon img{ width:100%; height:100%; object-fit:contain; image-rendering: -webkit-optimize-contrast; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4)); }
    .tile .initials{ font-weight:700; font-size: 14px; color: var(--muted); }
    .tile .label{ font-size: 12px; line-height: 1.15; max-width: calc(var(--tile-size) - 16px); text-align:center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0.95; }
    .tile .handle{ position:absolute; inset:auto 8px 8px auto; opacity:0; transition:opacity 120ms; font-size: 11px; color:#e2e8f0; background: rgba(15,23,42,0.55); padding:2px 6px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.15); }
    .tile:hover .handle{ opacity:1; }
    .tile.dragging{ opacity:0.65; outline: 2px dashed rgba(255,255,255,0.35); }

    main{ display: flex; justify-content: center; align-items: center; }
    .grid{ max-width: calc((var(--tile-size) + var(--gap)) * 5); }

    .empty{ opacity:0.7; text-align:center; padding:40px 0; font-size:14px; }

    footer{ padding: 18px 28px; display:none; gap: 12px; align-items:center; backdrop-filter: blur(8px); }
    footer.visible{ display:flex; }
    .form{ display:flex; gap:8px; flex-wrap: wrap; }
    .form input{ width: 280px; max-width: 48vw; }
    .form input[name="title"]{ width: 200px; }

    .menu{ position: absolute; background: rgba(15,23,42,0.9); border:1px solid rgba(255,255,255,0.16); box-shadow: var(--shadow); border-radius: 12px; display:none; flex-direction:column; min-width: 160px; z-index: 50; }
    .menu button{ background: transparent; border:0; text-align:left; padding:10px 12px; font-size: 14px; }
    .menu button:hover{ background: rgba(255,255,255,0.08); }

    .toast{ position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%); background: rgba(15,23,42,0.92); border:1px solid rgba(255,255,255,0.18); color:var(--text); padding: 10px 14px; border-radius: 999px; display:none; box-shadow: var(--shadow); font-size: 13px; }
    
    .gear-button{ position: fixed; bottom: 28px; right: 28px; width: 48px; height: 48px; border-radius: 50%; background: var(--glass); border: 1px solid var(--glass-strong); display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(6px); box-shadow: var(--shadow); transition: transform 120ms ease, background 120ms ease; z-index: 100; }
    .gear-button:hover{ background: var(--glass-strong); transform: scale(1.05); }
    .gear-button:active{ transform: scale(0.95); }
    .gear-button svg{ width: 24px; height: 24px; fill: var(--text); opacity: 0.9; }

    /* Wallpaper Manager Modal */
    .modal{ position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(4px); }
    .modal.visible{ display: flex; }
    .modal-content{ background: rgba(15,23,42,0.95); border: 1px solid var(--glass-strong); border-radius: 16px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .modal-header{ display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2{ margin: 0; font-size: 20px; font-weight: 600; }
    .close-btn{ background: transparent; border: 0; color: var(--text); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
    .close-btn:hover{ background: rgba(255,255,255,0.1); }
    
    .manager-section{ margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .manager-section:last-child{ border-bottom: none; margin-bottom: 0; }
    .manager-section h3{ font-size: 16px; font-weight: 500; margin: 0 0 12px 0; opacity: 0.9; }
    
    .folder-list{ display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .folder-chip{ background: var(--glass); border: 1px solid var(--glass-strong); padding: 8px 12px; border-radius: 8px; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
    .folder-chip .delete-icon{ cursor: pointer; opacity: 0.6; transition: opacity 120ms; }
    .folder-chip .delete-icon:hover{ opacity: 1; color: #ef4444; }
    
    .image-grid{ display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 12px; }
    .image-item{ position: relative; aspect-ratio: 16/9; border-radius: 8px; overflow: hidden; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-strong); }
    .image-item img{ width: 100%; height: 100%; object-fit: cover; }
    .image-item .delete-overlay{ position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; cursor: pointer; }
    .image-item:hover .delete-overlay{ display: flex; }
    .image-item .delete-overlay svg{ width: 32px; height: 32px; fill: #ef4444; }
    
    .upload-area{ border: 2px dashed var(--glass-strong); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 120ms; }
    .upload-area:hover{ border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.02); }
    .upload-area.dragover{ border-color: #3b82f6; background: rgba(59,130,246,0.1); }
    .upload-area input[type="file"]{ display: none; }
    .upload-info{ font-size: 13px; opacity: 0.6; margin-top: 8px; }
    
    .input-group{ display: flex; gap: 8px; align-items: center; }
    .input-group input{ flex: 1; }
    
    /* Settings Panel */
    .settings-group{ margin-bottom: 16px; }
    .settings-group label{ display: block; font-size: 14px; margin-bottom: 6px; opacity: 0.9; }
    .toggle-switch{ position: relative; display: inline-block; width: 48px; height: 24px; }
    .toggle-switch input{ opacity: 0; width: 0; height: 0; }
    .toggle-slider{ position: absolute; cursor: pointer; inset: 0; background: rgba(255,255,255,0.2); border-radius: 24px; transition: 0.3s; }
    .toggle-slider:before{ position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
    .toggle-switch input:checked + .toggle-slider{ background: #3b82f6; }
    .toggle-switch input:checked + .toggle-slider:before{ transform: translateX(24px); }
    .color-picker-wrapper{ display: flex; gap: 8px; align-items: center; }
    .color-picker-wrapper input[type="color"]{ width: 48px; height: 36px; border: 1px solid var(--glass-strong); background: var(--glass); cursor: pointer; }
    .color-preview{ display: inline-flex; gap: 6px; }
    .color-chip{ width: 32px; height: 32px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; transition: transform 120ms; }
    .color-chip:hover{ transform: scale(1.1); }
    .color-chip.active{ border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
    
    /* Confirmation Modal */
    .confirm-modal .modal-content{ max-width: 400px; }
    .confirm-modal .modal-body{ margin: 16px 0 24px; font-size: 14px; line-height: 1.6; }
    .confirm-modal .modal-actions{ display: flex; gap: 8px; justify-content: flex-end; }
    .confirm-modal .modal-actions button{ height: 36px; min-width: 80px; }
    .btn-danger{ background: #ef4444; border-color: #dc2626; }
    .btn-danger:hover{ background: #dc2626; }
    
    /* Edit Tile Modal */
    .edit-tile-modal .modal-content{ max-width: 500px; }
    .edit-tile-modal .form-group{ margin-bottom: 16px; }
    .edit-tile-modal .form-group label{ display: block; margin-bottom: 6px; font-size: 14px; opacity: 0.9; }
    .edit-tile-modal .form-group input{ width: 100%; }
    .color-grid{ display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 8px; }
    .color-option{ width: 100%; aspect-ratio: 1; border-radius: 8px; border: 2px solid transparent; cursor: pointer; transition: all 120ms; position: relative; }
    .color-option:hover{ transform: scale(1.1); border-color: rgba(255,255,255,0.3); }
    .color-option.selected{ border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
    .color-option.selected::after{ content: '\u2713'; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
    </style>
  </head>
  <body>
    <div id="bg" class="bg"></div>
    <div class="scrim"></div>

    
    <div class="container">
    <header>
      <div class="clock-container">
        <div class="date" id="date">---</div>
        <div class="clock" id="clock">--:--</div>
      </div>
      <div class="controls">
      <select id="folderSelect" title="Select wallpaper folder">
        <option value="dark">Dark</option>
        <option value="nature">Nature</option>
      </select>
      <button id="shuffleBg" title="Change wallpaper">Change wallpaper</button>
      <button id="manageWallpapers" title="Manage wallpapers">Manage Wallpapers</button>
      <button id="exportBtn" title="Export shortcuts">Export</button>
      <button id="importBtn" title="Import shortcuts">Import</button>
      <input type="file" id="importFile" accept="application/json" style="display:none" />
      </div>
    </header>

    <main>
      <div id="grid" class="grid" aria-live="polite"></div>
      <div id="empty" class="empty" hidden>
        No shortcuts yet. Add one below. Drag to reorder. Right‑click a tile to edit or delete.
      </div>
    </main>

    <footer>
      <form id="addForm" class="form" autocomplete="off">
        <input name="url" type="url" placeholder="https://example.com" required />
        <input name="title" type="text" placeholder="Title (optional)" />
        <button type="submit">Add</button>
      </form>
    </footer>
  </div>

  <div id="menu" class="menu" role="menu" aria-hidden="true">
    <button data-action="open">Open</button>
    <button data-action="edit">Edit</button>
    <button data-action="delete">Delete</button>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal confirm-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="confirmTitle">Confirm</h2>
        <button class="close-btn" id="confirmClose">&times;</button>
      </div>
      <div class="modal-body" id="confirmMessage"></div>
      <div class="modal-actions">
        <button id="confirmCancel">Cancel</button>
        <button id="confirmOk" class="btn-danger">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Edit Tile Modal -->
  <div id="editTileModal" class="modal edit-tile-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Shortcut</h2>
        <button class="close-btn" id="editTileClose">&times;</button>
      </div>
      <div class="manager-section">
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="editTileTitle" placeholder="Title (optional)" />
        </div>
        <div class="form-group">
          <label>URL</label>
          <input type="url" id="editTileUrl" placeholder="https://example.com" required />
        </div>
        <div class="form-group">
          <label>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span>Use Initials</span>
              <label class="toggle-switch">
                <input type="checkbox" id="editTileUseInitials" />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </label>
        </div>
        <div class="form-group">
          <label>Icon Background Color</label>
          <div class="color-grid" id="editTileColorGrid"></div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="editTileCancel">Cancel</button>
        <button id="editTileSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Wallpaper Manager Modal -->
  <div id="wallpaperModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Manage Wallpapers</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      
      <div class="manager-section">
        <h3>Folders</h3>
        <div id="folderList" class="folder-list"></div>
        <div class="input-group">
          <input type="text" id="newFolderName" placeholder="New folder name" pattern="[a-zA-Z0-9_-]+" />
          <button id="createFolderBtn">Create Folder</button>
        </div>
      </div>
      
      <div class="manager-section">
        <h3>Upload Images</h3>
        <select id="uploadFolderSelect"></select>
        <div class="upload-area" id="uploadArea">
          <input type="file" id="imageUpload" accept="image/*" multiple />
          <p>Click to upload or drag and drop images</p>
          <p class="upload-info">Supports: JPG, PNG, WEBP, GIF (max 10MB each)</p>
        </div>
      </div>
      
      <div class="manager-section">
        <h3>Current Images</h3>
        <select id="viewFolderSelect"></select>
        <div id="imageGrid" class="image-grid"></div>
      </div>
    </div>
  </div>

  <button class="gear-button" id="gearBtn" title="Toggle controls" aria-label="Toggle controls">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
    </svg>
  </button>

  <script>
    // ---------- Utilities ----------
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
    const storageKey = 'newtab.shortcuts.v1';
    const bgKey = 'newtab.bg.seed';

    // Color palette with darker variants
    const colorPalette = [
      { name: 'Glass', color: 'rgba(255,255,255,0.12)' },
      { name: 'Glass Dark', color: 'rgba(255,255,255,0.08)' },
      { name: 'Blue', color: '#3b82f6' },
      { name: 'Blue Dark', color: '#1d4ed8' },
      { name: 'Purple', color: '#8b5cf6' },
      { name: 'Purple Dark', color: '#6d28d9' },
      { name: 'Pink', color: '#ec4899' },
      { name: 'Pink Dark', color: '#be185d' },
      { name: 'Red', color: '#ef4444' },
      { name: 'Red Dark', color: '#b91c1c' },
      { name: 'Orange', color: '#f59e0b' },
      { name: 'Orange Dark', color: '#d97706' },
      { name: 'Amber', color: '#f59e0b' },
      { name: 'Amber Dark', color: '#b45309' },
      { name: 'Green', color: '#10b981' },
      { name: 'Green Dark', color: '#047857' },
      { name: 'Emerald', color: '#34d399' },
      { name: 'Emerald Dark', color: '#059669' },
      { name: 'Teal', color: '#14b8a6' },
      { name: 'Teal Dark', color: '#0f766e' },
      { name: 'Cyan', color: '#06b6d4' },
      { name: 'Cyan Dark', color: '#0e7490' },
      { name: 'Sky', color: '#0ea5e9' },
      { name: 'Sky Dark', color: '#0369a1' },
      { name: 'Indigo', color: '#6366f1' },
      { name: 'Indigo Dark', color: '#4338ca' },
      { name: 'Violet', color: '#a855f7' },
      { name: 'Violet Dark', color: '#7c3aed' },
      { name: 'Fuchsia', color: '#d946ef' },
      { name: 'Fuchsia Dark', color: '#a21caf' },
      { name: 'Rose', color: '#f43f5e' },
      { name: 'Rose Dark', color: '#be123c' }
    ];

    function getShortcuts(){
      try { 
        const shortcuts = JSON.parse(localStorage.getItem(storageKey)) || [];
        // Migrate old shortcuts to new format with per-tile settings
        return shortcuts.map(s => ({
          title: s.title || '',
          url: s.url,
          useInitials: s.useInitials !== undefined ? s.useInitials : false,
          bgColor: s.bgColor || 'rgba(255,255,255,0.12)'
        }));
      } catch { return []; }
    }
    function setShortcuts(list){ localStorage.setItem(storageKey, JSON.stringify(list)); render(); }

    function normalizeURL(input){
      try {
      let url = new URL(input.includes('://') ? input : 'https://' + input);
      return url.href.replace(/\/$/, '');
      } catch (e){ throw new Error('Invalid URL'); }
    }
    function domainOf(href){ try{ return new URL(href).hostname; } catch { return href; } }
    function originOf(href){ try{ return new URL(href).origin; } catch { return href; } }
    function initialsFromTitle(title) { 
      if (!title) return '?';
      const words = title.trim().split(/\s+/);
      return words.slice(0, 2).map(w => w.charAt(0).toUpperCase()).join('');
    }
    function initialsFromHost(host){
      const core = host.replace(/^www\./,'').split('.')[0];
      return core.slice(0,3).toUpperCase();
    }

    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(toast._id); toast._id=setTimeout(()=> t.style.display='none', 1800); }

    // ---------- Background (dynamic wallpapers) ----------
    let wallpapers = {};
    
    const folderKey = 'newtab.wallpaper.folder';
    const indexKey = 'newtab.wallpaper.index';
    
    // Load wallpapers dynamically from API or JSON file
    async function loadWallpapers() {
      try {
        // Try API endpoint first (for local dev server)
        let response = await fetch('/api/wallpapers');
        if (!response.ok) {
          // Fallback to static JSON file (for Firebase hosting)
          response = await fetch('/wallpapers.json');
        }
        wallpapers = await response.json();
        
        // Populate folder dropdown
        const folderSelect = $('#folderSelect');
        folderSelect.innerHTML = '';
        Object.keys(wallpapers).sort().forEach(folder => {
          const option = document.createElement('option');
          option.value = folder;
          option.textContent = folder.charAt(0).toUpperCase() + folder.slice(1);
          folderSelect.appendChild(option);
        });
        
        return true;
      } catch (error) {
        console.error('Failed to load wallpapers:', error);
        toast('Failed to load wallpapers');
        return false;
      }
    }
    
    function getSelectedFolder(){
      const saved = localStorage.getItem(folderKey);
      const folders = Object.keys(wallpapers);
      // If saved folder doesn't exist, use first available
      return (saved && wallpapers[saved]) ? saved : folders[0] || 'dark';
    }
    
    function setBackground(folder, forceNew=false){
      const images = wallpapers[folder];
      if (!images || images.length === 0) {
        console.error('No images found for folder:', folder);
        return;
      }
      
      let index = parseInt(localStorage.getItem(indexKey) || '0', 10);
      
      if(forceNew){
        // Get next image in rotation
        index = (index + 1) % images.length;
        localStorage.setItem(indexKey, index.toString());
      }
      
      // Ensure index is valid
      if (index >= images.length) {
        index = 0;
        localStorage.setItem(indexKey, '0');
      }
      
      const imagePath = `wallpapers/${folder}/${images[index]}`;
      $('#bg').style.backgroundImage = `url('${imagePath}')`;
    }
    
    async function initBackground(forceNew=false){
      await loadWallpapers();
      const folder = getSelectedFolder();
      setBackground(folder, forceNew);
      $('#folderSelect').value = folder;
    }

    // ---------- Clock ----------
    function tickClock(){
      const d = new Date();
      const timeOpts = { hour: '2-digit', minute: '2-digit' };
      $('#clock').textContent = d.toLocaleTimeString([], timeOpts);
      
      const dateOpts = { weekday: 'short', month: 'short', day: 'numeric' };
      $('#date').textContent = d.toLocaleDateString([], dateOpts);
    }

    // ---------- Grid Rendering ----------
    let draggedElement = null;
    let draggedIndex = null;
    
    function createTile(item, index){
      const a = document.createElement('a');
      a.className = 'tile';
      a.href = item.url; a.target = '_self'; a.draggable = true; a.dataset.index = index;

      const icon = document.createElement('div');
      icon.className = 'favicon';
      icon.style.background = item.bgColor || 'rgba(255,255,255,0.12)';
      
      if (item.useInitials) {
        // Always show initials
        const initials = document.createElement('div');
        initials.className = 'initials';
        initials.textContent = initialsFromTitle(item.title) || initialsFromHost(domainOf(item.url));
        icon.appendChild(initials);
      } else {
        // Try to load favicon
        const img = document.createElement('img');
        img.alt = '';
        const origin = originOf(item.url);
        img.src = `${origin}/favicon.ico`;
        img.onerror = () => { 
          img.replaceWith(Object.assign(document.createElement('div'), {
            className:'initials', 
            textContent: initialsFromTitle(item.title) || initialsFromHost(domainOf(item.url))
          })); 
        };
        icon.appendChild(img);
      }

      const label = document.createElement('div');
      label.className = 'label';
      label.title = item.title || domainOf(item.url);
      label.textContent = item.title || domainOf(item.url);

      const handle = document.createElement('div');
      handle.className = 'handle';
      handle.textContent = '⋮⋮';

      a.append(icon, label, handle);

      // context menu
      a.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        showMenu(e.pageX, e.pageY, index);
      });

      // Drag + drop - improved implementation
      a.addEventListener('dragstart', e=>{
        draggedElement = a;
        draggedIndex = index;
        a.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', a.innerHTML);
      });
      
      a.addEventListener('dragend', ()=> {
        a.classList.remove('dragging');
        draggedElement = null;
        draggedIndex = null;
      });

      a.addEventListener('dragover', e=>{
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === index) return;
        
        e.dataTransfer.dropEffect = 'move';
        
        // Get all tiles
        const tiles = Array.from($('#grid').children);
        const draggedTile = tiles[draggedIndex];
        const currentTile = tiles[index];
        
        if (!draggedTile || !currentTile) return;
        
        // Determine if we should insert before or after
        const rect = currentTile.getBoundingClientRect();
        const midpoint = rect.left + rect.width / 2;
        const insertBefore = e.clientX < midpoint;
        
        if (insertBefore) {
          currentTile.parentNode.insertBefore(draggedTile, currentTile);
        } else {
          currentTile.parentNode.insertBefore(draggedTile, currentTile.nextSibling);
        }
        
        // Update indices
        tiles.forEach((tile, idx) => {
          tile.dataset.index = idx;
        });
      });
      
      a.addEventListener('drop', e=>{
        e.preventDefault();
        if (draggedIndex === null) return;
        
        // Get final order from DOM
        const tiles = Array.from($('#grid').children);
        const newOrder = tiles.map(tile => {
          const idx = parseInt(tile.dataset.index);
          return getShortcuts()[idx];
        });
        
        // Save new order without triggering render
        localStorage.setItem(storageKey, JSON.stringify(newOrder));
        
        // Update all tile indices to match new order
        tiles.forEach((tile, idx) => {
          tile.dataset.index = idx;
        });
      });

      return a;
    }

    function render(){
      const list = getShortcuts();
      const grid = $('#grid');
      grid.innerHTML = '';
      if(list.length === 0){ $('#empty').hidden = false; return; }
      $('#empty').hidden = true;
      list.forEach((item, i)=> grid.appendChild(createTile(item, i)));
    }

    // ---------- Modal Utilities ----------
    function showConfirm(title, message) {
      return new Promise((resolve) => {
        $('#confirmTitle').textContent = title;
        $('#confirmMessage').textContent = message;
        $('#confirmModal').classList.add('visible');
        
        const handleOk = () => {
          cleanup();
          resolve(true);
        };
        const handleCancel = () => {
          cleanup();
          resolve(false);
        };
        const cleanup = () => {
          $('#confirmModal').classList.remove('visible');
          $('#confirmOk').removeEventListener('click', handleOk);
          $('#confirmCancel').removeEventListener('click', handleCancel);
          $('#confirmClose').removeEventListener('click', handleCancel);
        };
        
        $('#confirmOk').addEventListener('click', handleOk);
        $('#confirmCancel').addEventListener('click', handleCancel);
        $('#confirmClose').addEventListener('click', handleCancel);
      });
    }
    
    function showEditTile(item, index) {
      $('#editTileTitle').value = item.title || '';
      $('#editTileUrl').value = item.url;
      $('#editTileUseInitials').checked = item.useInitials || false;
      
      // Populate color grid
      const colorGrid = $('#editTileColorGrid');
      colorGrid.innerHTML = '';
      colorPalette.forEach(c => {
        const colorOption = document.createElement('div');
        colorOption.className = 'color-option';
        colorOption.style.background = c.color;
        colorOption.title = c.name;
        colorOption.dataset.color = c.color;
        if (c.color === (item.bgColor || 'rgba(255,255,255,0.12)')) {
          colorOption.classList.add('selected');
        }
        colorOption.addEventListener('click', () => {
          $$('.color-option', colorGrid).forEach(o => o.classList.remove('selected'));
          colorOption.classList.add('selected');
        });
        colorGrid.appendChild(colorOption);
      });
      
      $('#editTileModal').classList.add('visible');
      
      return new Promise((resolve) => {
        const handleSave = () => {
          const title = $('#editTileTitle').value.trim();
          const url = $('#editTileUrl').value.trim();
          const useInitials = $('#editTileUseInitials').checked;
          const selected = $('.color-option.selected', colorGrid);
          const bgColor = selected ? selected.dataset.color : 'rgba(255,255,255,0.12)';
          
          if (!url) {
            toast('URL is required');
            return;
          }
          
          try {
            const normalized = normalizeURL(url);
            cleanup();
            resolve({ title, url: normalized, useInitials, bgColor });
          } catch {
            toast('Invalid URL');
          }
        };
        
        const handleCancel = () => {
          cleanup();
          resolve(null);
        };
        
        const cleanup = () => {
          $('#editTileModal').classList.remove('visible');
          $('#editTileSave').removeEventListener('click', handleSave);
          $('#editTileCancel').removeEventListener('click', handleCancel);
          $('#editTileClose').removeEventListener('click', handleCancel);
        };
        
        $('#editTileSave').addEventListener('click', handleSave);
        $('#editTileCancel').addEventListener('click', handleCancel);
        $('#editTileClose').addEventListener('click', handleCancel);
      });
    }

    // ---------- Context menu actions ----------
    let currentIndex = null;
    function showMenu(x,y, index){
      currentIndex = index;
      const m = $('#menu');
      m.style.display='flex';
      m.style.left = x + 'px';
      m.style.top = y + 'px';
      m.setAttribute('aria-hidden','false');
    }
    function hideMenu(){ const m=$('#menu'); m.style.display='none'; m.setAttribute('aria-hidden','true'); }
    document.addEventListener('click', (e)=>{
      const m=$('#menu'); if(m.style.display==='flex' && !m.contains(e.target)) hideMenu();
    });

    $('#menu').addEventListener('click', async (e)=>{
      if(!(e.target instanceof HTMLElement)) return;
      const action = e.target.dataset.action;
      const list = getShortcuts();
      const item = list[currentIndex];
      if(!item) return hideMenu();

      if(action === 'open'){
        location.href = item.url;
      }
      if(action === 'edit'){
        hideMenu();
        const result = await showEditTile(item, currentIndex);
        if(result) {
          list[currentIndex] = result;
          setShortcuts(list);
          toast('Shortcut updated');
        }
      }
      if(action === 'delete'){
        hideMenu();
        const confirmed = await showConfirm('Delete Shortcut', `Delete "${item.title || domainOf(item.url)}"?`);
        if(confirmed){
          list.splice(currentIndex,1);
          setShortcuts(list);
          toast('Deleted');
        }
      }
      if(action === 'open') hideMenu();
    });

    // ---------- Add form ----------
    $('#addForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const rawUrl = fd.get('url');
      const rawTitle = (fd.get('title') || '').toString().trim();
      try{
        const url = normalizeURL(String(rawUrl));
        const title = rawTitle || domainOf(url);
        const list = getShortcuts();
        // dedupe by URL
        if(list.some(x => x.url === url)){
          toast('Already added');
        }else{
          list.push({ 
            title, 
            url,
            useInitials: false,
            bgColor: 'rgba(255,255,255,0.12)'
          });
          setShortcuts(list);
          toast('Added');
        }
        e.target.reset();
      }catch(err){ toast('Enter a valid URL'); }
    });

    // ---------- Export / Import ----------
    $('#exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(getShortcuts(), null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'shortcuts.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    $('#importBtn').addEventListener('click', ()=> $('#importFile').click());
    $('#importFile').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!Array.isArray(data)) throw new Error('Invalid');
        const cleaned = data.map(x=> ({ title: String(x.title||''), url: normalizeURL(String(x.url)) }));
        setShortcuts(cleaned);
        toast('Imported');
      }catch(err){ toast('Import failed'); }
      e.target.value = '';
    });

    // ---------- Buttons ----------
    $('#shuffleBg').addEventListener('click', ()=>{ initBackground(true); toast('Wallpaper changed'); });
    
    $('#folderSelect').addEventListener('change', (e)=>{
      const folder = e.target.value;
      localStorage.setItem(folderKey, folder);
      localStorage.setItem(indexKey, '0'); // Reset to first image
      setBackground(folder, false);
      toast(`Switched to ${folder}`);
    });
    
    // ---------- Gear button toggle ----------
    $('#gearBtn').addEventListener('click', ()=>{
      const controls = $('.controls');
      const footer = $('footer');
      controls.classList.toggle('visible');
      footer.classList.toggle('visible');
    });

    // ---------- Wallpaper Manager ----------
    let currentManagerFolder = null;
    
    $('#manageWallpapers').addEventListener('click', ()=> openWallpaperManager());
    $('#closeModal').addEventListener('click', ()=> closeWallpaperManager());
    $('#wallpaperModal').addEventListener('click', (e)=> { if(e.target.id === 'wallpaperModal') closeWallpaperManager(); });
    
    async function openWallpaperManager() {
      await loadWallpapers();
      populateFolderList();
      populateFolderSelects();
      loadSettings();
      currentManagerFolder = Object.keys(wallpapers)[0];
      if(currentManagerFolder) {
        $('#viewFolderSelect').value = currentManagerFolder;
        $('#uploadFolderSelect').value = currentManagerFolder;
        loadImagesForFolder(currentManagerFolder);
      }
      $('#wallpaperModal').classList.add('visible');
    }
    
    function closeWallpaperManager() {
      $('#wallpaperModal').classList.remove('visible');
    }
    
    function populateFolderList() {
      const list = $('#folderList');
      list.innerHTML = '';
      Object.keys(wallpapers).sort().forEach(folder => {
        const chip = document.createElement('div');
        chip.className = 'folder-chip';
        chip.innerHTML = `
          <span>${folder}</span>
          <span class="delete-icon" data-folder="${folder}">✕</span>
        `;
        list.appendChild(chip);
      });
      
      // Add delete handlers
      $$('.delete-icon', list).forEach(icon => {
        icon.addEventListener('click', async () => {
          const folder = icon.dataset.folder;
          const confirmed = await showConfirm('Delete Folder', `Delete folder "${folder}" and all its images?`);
          if(confirmed) {
            await deleteFolder(folder);
          }
        });
      });
    }
    
    function populateFolderSelects() {
      const folders = Object.keys(wallpapers).sort();
      ['uploadFolderSelect', 'viewFolderSelect'].forEach(id => {
        const select = $(`#${id}`);
        select.innerHTML = '';
        folders.forEach(folder => {
          const option = document.createElement('option');
          option.value = folder;
          option.textContent = folder.charAt(0).toUpperCase() + folder.slice(1);
          select.appendChild(option);
        });
      });
    }
    
    function loadImagesForFolder(folder) {
      const grid = $('#imageGrid');
      grid.innerHTML = '';
      const images = wallpapers[folder] || [];
      
      if(images.length === 0) {
        grid.innerHTML = '<p style="opacity:0.6; text-align:center; padding:20px;">No images in this folder</p>';
        return;
      }
      
      images.forEach(filename => {
        const item = document.createElement('div');
        item.className = 'image-item';
        item.innerHTML = `
          <img src="wallpapers/${folder}/${filename}" alt="${filename}" loading="lazy" />
          <div class="delete-overlay" data-folder="${folder}" data-file="${filename}">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
          </div>
        `;
        grid.appendChild(item);
      });
      
      // Add delete handlers
      $$('.delete-overlay', grid).forEach(overlay => {
        overlay.addEventListener('click', async () => {
          const folder = overlay.dataset.folder;
          const file = overlay.dataset.file;
          const confirmed = await showConfirm('Delete Image', `Delete ${file}?`);
          if(confirmed) {
            await deleteImage(folder, file);
          }
        });
      });
    }
    
    $('#createFolderBtn').addEventListener('click', async ()=> {
      const name = $('#newFolderName').value.trim();
      if(!name) return toast('Enter a folder name');
      if(!/^[a-zA-Z0-9_-]+$/.test(name)) return toast('Use only letters, numbers, hyphens, and underscores');
      
      try {
        const response = await fetch('/api/wallpapers/folders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        const data = await response.json();
        
        if(data.success) {
          toast('Folder created');
          $('#newFolderName').value = '';
          await loadWallpapers();
          populateFolderList();
          populateFolderSelects();
        } else {
          toast(data.error || 'Failed to create folder');
        }
      } catch(err) {
        toast('Error creating folder');
        console.error(err);
      }
    });
    
    $('#viewFolderSelect').addEventListener('change', (e)=> {
      currentManagerFolder = e.target.value;
      loadImagesForFolder(currentManagerFolder);
    });
    
    // Upload area handlers
    const uploadArea = $('#uploadArea');
    const imageUpload = $('#imageUpload');
    
    uploadArea.addEventListener('click', ()=> imageUpload.click());
    
    uploadArea.addEventListener('dragover', (e)=> {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', ()=> uploadArea.classList.remove('dragover'));
    
    uploadArea.addEventListener('drop', async (e)=> {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
      if(files.length > 0) await uploadImages(files);
    });
    
    imageUpload.addEventListener('change', async (e)=> {
      const files = Array.from(e.target.files);
      if(files.length > 0) await uploadImages(files);
      e.target.value = '';
    });
    
    async function uploadImages(files) {
      const folder = $('#uploadFolderSelect').value;
      if(!folder) return toast('Select a folder first');
      
      const formData = new FormData();
      formData.append('folder', folder);
      files.forEach(file => formData.append('images', file));
      
      try {
        toast('Uploading...');
        const response = await fetch('/api/wallpapers/upload', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        
        if(data.success) {
          toast(`Uploaded ${data.files.length} image(s)`);
          await loadWallpapers();
          if($('#viewFolderSelect').value === folder) {
            loadImagesForFolder(folder);
          }
        } else {
          toast(data.error || 'Upload failed');
        }
      } catch(err) {
        toast('Error uploading images');
        console.error(err);
      }
    }
    
    async function deleteImage(folder, filename) {
      try {
        const response = await fetch(`/api/wallpapers/${folder}/${filename}`, {
          method: 'DELETE'
        });
        const data = await response.json();
        
        if(data.success) {
          toast('Image deleted');
          await loadWallpapers();
          loadImagesForFolder(folder);
        } else {
          toast(data.error || 'Failed to delete image');
        }
      } catch(err) {
        toast('Error deleting image');
        console.error(err);
      }
    }
    
    async function deleteFolder(folder) {
      try {
        const response = await fetch(`/api/wallpapers/folders/${folder}`, {
          method: 'DELETE'
        });
        const data = await response.json();
        
        if(data.success) {
          toast('Folder deleted');
          await loadWallpapers();
          populateFolderList();
          populateFolderSelects();
          const folders = Object.keys(wallpapers);
          if(folders.length > 0) {
            currentManagerFolder = folders[0];
            $('#viewFolderSelect').value = currentManagerFolder;
            loadImagesForFolder(currentManagerFolder);
          } else {
            $('#imageGrid').innerHTML = '';
          }
        } else {
          toast(data.error || 'Failed to delete folder');
        }
      } catch(err) {
        toast('Error deleting folder');
        console.error(err);
      }
    }
    
    // ---------- Init ----------
    initBackground(true); // Rotate wallpaper on each page load
    tickClock(); setInterval(tickClock, 1000);
    render();

    // Accessibility: close menu with escape
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideMenu(); });
  </script>
</body>
</html>
